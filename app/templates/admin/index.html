{% extends "base.html" %}
{% block title %}Admin · {{ request.state.instance_settings.site_name if request.state.instance_settings else 'Admin' }}{% endblock %}
{% block content %}
<section class="stack">
    <div class="row align-center gap">
        <p class="eyebrow">Administrator</p>
        {% include 'partials/admin_badge.html' %}
    </div>
    <h1>Admin console</h1>
    <p class="lede">Configure instance-wide defaults and review operational status. Admin access is gated by an environment token or an allowlisted npub.</p>
</section>

{% if not is_admin %}
    <section class="card stack">
        <h2>Sign in as admin</h2>
        <form class="stack" action="/admin/login" method="post">
            <input type="hidden" name="csrf" value="{{ csrf }}">
            {% if error %}
                <div class="alert">{{ error }}</div>
            {% endif %}
            {% if has_token %}
                <label class="field">
                    <span>Admin token</span>
                    <input type="password" name="admin_token_input" placeholder="Enter admin token" autocomplete="current-password">
                    <span class="muted small">Token is compared to the server ENV `ADMIN_TOKEN`. It is not stored.</span>
                </label>
                <button type="submit" class="button">Continue</button>
            {% endif %}
            {% if allowlisted %}
                <p class="muted">Your current npub session is on the admin allowlist. Submit to continue.</p>
                <button type="submit" class="ghost">Continue with npub access</button>
            {% else %}
                <p class="muted small">Nostr allowlist admins: sign in via your npub session and visit this page again.</p>
            {% endif %}
        </form>
    </section>
{% else %}
    <section class="stack">
        <div class="card stack">
            <div class="row space-between align-center">
                <div>
                    <p class="eyebrow">Instance</p>
                    <h3>{{ settings.site_name }}</h3>
                    <p class="muted small">{{ settings.site_tagline or 'No tagline set.' }}</p>
                </div>
                <a class="button" href="/admin/settings">Edit settings</a>
            </div>
            <div class="row gap wrap muted small">
                <span>Default relays: {{ settings.default_relays or 'Not set' }}</span>
                <span class="dot">•</span>
                <span>Max feed items: {{ settings.max_feed_items }}</span>
                <span class="dot">•</span>
                <span>Session default: {{ settings.session_default_minutes }} minutes</span>
            </div>
        </div>
        <div class="card stack">
            <div class="row space-between align-center">
                <div>
                    <p class="eyebrow">Session</p>
                    <h3>Admin session</h3>
                    <p class="muted small">Logged in{% if auth_session and auth_session.npub %} as {{ auth_session.npub }}{% endif %}.</p>
                </div>
                <form action="/admin/logout" method="post">
                    <input type="hidden" name="csrf" value="{{ csrf }}">
                    <button type="submit" class="ghost">Sign out</button>
                </form>
            </div>
            <div class="muted small">Updated at: {{ settings.updated_at }}</div>
        </div>
    </section>
{% endif %}
{% endblock %}
